# Формат обращения к AI агенту

Бот отправляет JSON в AI агент через POST запрос на адрес `AI_AGENT_URL` из `.env`.

**Важно:** AI агент получает запросы от бота и преобразует их в формат бэкенда. AI агент должен:
1. Получить `endpoint` и понять, какой endpoint бэкенда нужно вызвать
2. Преобразовать данные из формата бота в формат бэкенда
3. Добавить `tg_id` во все запросы к бэкенду (если требуется)
4. Вызвать соответствующий endpoint бэкенда

## Общий формат запроса

Все запросы имеют одинаковую структуру:

```json
{
  "endpoint": "/endpoint_name",
  "data": {
    // Данные для обработки
  },
  "tg_id": 123456789,
  "timestamp": 1703520000
}
```

**HTTP метод:** `POST`  
**Content-Type:** `application/json`  
**URL:** `{AI_AGENT_URL}{endpoint}`

**Поля:**
- `endpoint` - endpoint, который AI агент должен вызвать в бэкенде (например, `/api/tool/generate_text`)
- `data` - данные для обработки (формат зависит от endpoint)
- `tg_id` - ID пользователя Telegram (обязательно для всех запросов)
- `timestamp` - временная метка запроса

---

## 0. Инициализация пользователя

**Endpoint бота → AI агент:** `POST /api/auth/init`  
**Endpoint AI агент → Бэкенд:** `POST /api/auth/init` (если AI агент вызывает бэкенд)

**Пример запроса от бота:**
```json
{
  "tg_id": 123456789,
  "username": "test_user"
}
```

**Примечание:** 
- Для `/api/auth/init` бот отправляет данные **напрямую** в формате `InitUserRequest` (без обёртки)
- Для всех остальных endpoints используется обёрнутый формат с полями `endpoint`, `data`, `tg_id`, `timestamp`
- Вызывается автоматически при первом взаимодействии пользователя с ботом (команда `/start`)

**Ожидаемый ответ от AI агента:**
```json
{
  "status": "initialized",
  "tg_id": 123456789
}
```

---

## 1. Генерация текста (свободная форма)

**Endpoint бота → AI агент:** `POST /generate_text`  
**Endpoint AI агент → Бэкенд:** `POST /api/tool/generate_text`

**Пример запроса от бота:**
```json
{
  "endpoint": "/generate_text",
  "data": {
    "prompt": "Создай пост для НКО 'Помощь бездомным' о благотворительном концерте. Стиль: разговорный, дружелюбный. Идея: анонс концерта 25 декабря",
    "nko": {
      "name": "Помощь бездомным",
      "description": "Помогаем людям без жилья",
      "activities": "Раздача еды, одежды, помощь в трудоустройстве",
      "style": "разговорный"
    }
  },
  "tg_id": 123456789,
  "timestamp": 1703520000
}
```

**AI агент должен:**
1. Использовать данные `nko` для улучшения промпта (если нужно)
2. Вызвать бэкенд: `POST /api/tool/generate_text` с телом:
```json
{
  "prompt": "Улучшенный промпт с учетом данных НКО..."
}
```

**Ожидаемый ответ:**
```json
{
  "post_id": "uuid-string",
  "post_author": 0,
  "assigned_chat_id": [],
  "main_text": "Сгенерированный текст поста...",
  "content": []
}
```

---

## 2. Генерация текста (структурированная форма)

**Endpoint бота → AI агент:** `POST /generate_text`  
**Endpoint AI агент → Бэкенд:** `POST /api/tool/generate_text`

**Пример запроса от бота:**
```json
{
  "endpoint": "/generate_text",
  "data": {
    "prompt": "Создай пост для НКО 'Помощь бездомным' о событии:\nСобытие: благотворительный концерт\nДата: 25 декабря 2024\nМесто: Концертный зал, ул. Примерная, 1\nПриглашены: известные музыканты, волонтёры\nДетали: Начало в 19:00, вход свободный, сбор средств для детского дома",
    "nko": {
      "name": "Помощь бездомным",
      "description": "Помогаем людям без жилья",
      "activities": "Раздача еды, одежды",
      "style": "разговорный"
    }
  },
  "tg_id": 123456789,
  "timestamp": 1703520000
}
```

**AI агент должен:** (аналогично пункту 1)

**Ожидаемый ответ:** (такой же как в пункте 1)

---

## 3. Генерация изображения (по описанию)

**Endpoint бота → AI агент:** `POST /generate_image`  
**Endpoint AI агент → Бэкенд:** `POST /api/tool/generate_image`

**Пример запроса от бота:**
```json
{
  "endpoint": "/generate_image",
  "data": {
    "desc": "Яркое изображение с людьми, помогающими друг другу",
    "nko": {
      "name": "Помощь бездомным",
      "description": "Помогаем людям без жилья",
      "activities": "Раздача еды, одежды",
      "style": "разговорный"
    }
  },
  "tg_id": 123456789,
  "timestamp": 1703520000
}
```

**AI агент должен:**
1. Преобразовать `desc` в `prompt` (можно улучшить с учетом данных `nko`)
2. Вызвать бэкенд: `POST /api/tool/generate_image` с телом:
```json
{
  "prompt": "Яркое изображение с людьми, помогающими друг другу",
  "aspect_ratio": "1x1"
}
```

**Пример запроса (с загруженным изображением):**
```json
{
  "endpoint": "/generate_image",
  "data": {
    "desc": "Обработать изображение",
    "image_url": "https://api.telegram.org/file/bot{token}/{file_path}",
    "file_id": "AgACAgIAAxkBAAIBY2...",
    "nko": {
      "name": "Помощь бездомным",
      "description": "Помогаем людям без жилья",
      "activities": "Раздача еды, одежды",
      "style": "разговорный"
    }
  },
  "tg_id": 123456789,
  "timestamp": 1703520000
}
```

**Примечание:** Если есть `image_url`, AI агент должен обработать изображение (например, загрузить и преобразовать в base64 или передать URL в бэкенд, в зависимости от требований бэкенда).

**Ожидаемый ответ:**
```json
{
  "post_id": "uuid-string",
  "post_author": 123456789,
  "assigned_chat_id": [],
  "main_text": "",
  "content": [
    {
      "layer_id": "a1b2c3d4-e5f6-7890-g1h2-i3j4k5l6m7n8",
      "type": "image",
      "order_index": 0,
      "data": {
        "image_base64": "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",
        "x": 50,
        "y": 100,
        "scale": 1.0,
        "rotation": 0,
        "opacity": 1.0,
        "crop": {
          "x": 0,
          "y": 0,
          "w": 800,
          "h": 600
        }
      }
    }
  ]
}
```

**Важно:** 
- Изображение передаётся в бинарном формате как base64 строка в поле `image_base64`
- Бот декодирует base64 и отправляет изображение пользователю через Telegram API
- Для обратной совместимости поддерживается fallback на `url` (если `image_base64` отсутствует)

**Пример полного ответа с изображением:**
```json
{
  "post_id": "gfhdfpvcd3fdwpekc0dsc23kf",
  "post_author": 123456789,
  "assigned_chat_id": [-1001234567890],
  "main_text": "",
  "content": [
    {
      "layer_id": "b2c3d4e5-f6g7-8901-h2i3-j4k5l6m7n8o9",
      "type": "image",
      "order_index": 1,
      "data": {
        "image_base64": "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",
        "x": 50,
        "y": 100,
        "scale": 1.0,
        "rotation": 0,
        "opacity": 1.0,
        "crop": {
          "x": 0,
          "y": 0,
          "w": 800,
          "h": 600
        }
      }
    }
  ]
}
```

---

## 4. Редактирование текста

**Endpoint бота → AI агент:** `POST /edit_text`  
**Endpoint AI агент → Бэкенд:** `POST /api/tool/generate_text` (или другой endpoint для редактирования, в зависимости от реализации бэкенда)

**Пример запроса от бота:**
```json
{
  "endpoint": "/edit_text",
  "data": {
    "text": "Текст с ошибками и плохим стилем, который нужно исправить"
  },
  "tg_id": 123456789,
  "timestamp": 1703520000
}
```

**AI агент должен:**
1. Сформировать промпт для исправления текста (например: "Исправь ошибки и улучши стиль следующего текста: ...")
2. Вызвать соответствующий endpoint бэкенда

**Ожидаемый ответ:**
```json
{
  "post_id": "",
  "post_author": 0,
  "assigned_chat_id": [],
  "main_text": "Исправленный и улучшенный текст",
  "content": []
}
```

---

## 5. Создание контент-плана

**Endpoint бота → AI агент:** `POST /content_plan`  
**Endpoint AI агент → Бэкенд:** `POST /api/tool/generate_text` (сформировать промпт для контент-плана)

**Пример запроса от бота:**
```json
{
  "endpoint": "/content_plan",
  "data": {
    "days": "7",
    "freq": "ежедневно",
    "nko": {
      "name": "Помощь бездомным",
      "description": "Помогаем людям без жилья",
      "activities": "Раздача еды, одежды",
      "style": "разговорный"
    }
  },
  "tg_id": 123456789,
  "timestamp": 1703520000
}
```

**AI агент должен:**
1. Сформировать промпт для создания контент-плана на основе `days`, `freq` и данных `nko`
2. Вызвать бэкенд: `POST /api/tool/generate_text` с промптом

**Возможные значения `freq`:**
- `"ежедневно"`
- `"через день"`
- `"2 раза в неделю"`
- `"3 раза в неделю"`

**Ожидаемый ответ:**
```json
{
  "post_id": "",
  "post_author": 0,
  "assigned_chat_id": [],
  "main_text": "День 1 (Понедельник, 25.12.2024)\nКатегория: Новости\nТема: ...\n\nДень 2 (Вторник, 26.12.2024)\n...",
  "content": []
}
```

---

## 6. Отправка поста

**Endpoint бота → AI агент:** `POST /send_post`  
**Endpoint AI агент → Бэкенд:** `POST /api/post/{post_id}/publish` (или другой endpoint для отправки)

**Пример запроса от бота:**
```json
{
  "endpoint": "/send_post",
  "data": {
    "post_id": "uuid-string",
    "chat_id": "-1001234567890"
  },
  "tg_id": 123456789,
  "timestamp": 1703520000
}
```

**AI агент должен:**
1. Вызвать соответствующий endpoint бэкенда для публикации/отправки поста
2. Передать `post_id` и `chat_id` (или `assigned_chat_id`)

**Ожидаемый ответ:**
```json
{
  "status": "ok"
}
```

---

## 7. Перегенерация поста

**Endpoint бота → AI агент:** `POST /regenerate_post`  
**Endpoint AI агент → Бэкенд:** `POST /api/post/{post_id}/main_text` (или другой endpoint для перегенерации)

**Пример запроса от бота:**
```json
{
  "endpoint": "/regenerate_post",
  "data": {
    "post_id": "uuid-string",
    "regenerate": true
  },
  "tg_id": 123456789,
  "timestamp": 1703520000
}
```

**AI агент должен:**
1. Получить исходный пост из бэкенда (если нужно)
2. Сформировать промпт для перегенерации
3. Вызвать соответствующий endpoint бэкенда

**Ожидаемый ответ:**
```json
{
  "post_id": "uuid-string",
  "post_author": 0,
  "assigned_chat_id": [],
  "main_text": "Перегенерированный текст поста...",
  "content": []
}
```

---

## Обработка ошибок

Если AI агент возвращает ошибку (status code != 200), бот получает сообщение об ошибке:

**Пример ошибки:**
```
AI agent error: status 500, details: {"error": "Internal server error"}
```

Бот отображает пользователю соответствующее сообщение:
- `❌ Ошибка генерации текста: ...` - для генерации текста
- `❌ Ошибка генерации изображения: ...` - для генерации изображения
- `❌ Ошибка редактирования текста: ...` - для редактора
- `❌ Ошибка создания контент-плана: ...` - для контент-плана
- `❌ Ошибка перегенерации поста: ...` - для перегенерации
- `❌ Ошибка отправки поста: ...` - для отправки

---

## Соответствие endpoints

| Endpoint бота → AI агент | Endpoint AI агент → Бэкенд | Описание |
|-------------------------|---------------------------|----------|
| `/api/auth/init` | `/api/auth/init` | Инициализация пользователя |
| `/generate_text` | `/api/tool/generate_text` | Генерация текста |
| `/generate_image` | `/api/tool/generate_image` | Генерация изображения |
| `/edit_text` | `/api/tool/generate_text` | Редактирование текста (через промпт) |
| `/content_plan` | `/api/tool/generate_text` | Создание контент-плана (через промпт) |
| `/send_post` | `/api/post/{post_id}/publish` | Отправка/публикация поста |
| `/regenerate_post` | `/api/post/{post_id}/main_text` | Перегенерация поста |

**Важно:** AI агент должен преобразовывать данные из формата бота в формат бэкенда. Например:
- Бот отправляет `desc` → AI агент преобразует в `prompt`
- Бот отправляет `nko` данные → AI агент использует их для улучшения промпта
- Бот отправляет `tg_id` в корне запроса → AI агент должен использовать его при вызове бэкенда

## Логирование

Бот логирует все отправляемые JSON в консоль:
```
[DEBUG] Sending to AI agent (/generate_text): {"endpoint":"/generate_text","data":{...},"tg_id":123456789,"timestamp":1703520000}
[DEBUG] Initializing user: tg_id=123456789, username=test_user
[DEBUG] User initialized successfully: tg_id=123456789
```

Это помогает отлаживать формат запросов.

## Важные замечания

1. **tg_id обязателен:** Все запросы от бота содержат `tg_id` в корне JSON. AI агент должен использовать его при вызове бэкенда.

2. **Инициализация пользователя:** При первом взаимодействии (команда `/start`) бот автоматически вызывает `/api/auth/init` для инициализации пользователя в бэкенде.

3. **Преобразование данных:** AI агент должен преобразовывать данные из формата бота в формат бэкенда:
   - `desc` → `prompt` (для генерации изображений)
   - `nko` данные используются для улучшения промпта, но не передаются напрямую в бэкенд
   - `text` → формируется промпт для редактирования

4. **Формат ответа:** Все ответы от AI агента должны быть в формате `PostJSON` (см. примеры выше).

